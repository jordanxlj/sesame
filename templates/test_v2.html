<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LightWeight Charts V2.1.0 - 核心系统测试</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .header h1 {
            color: #333;
            margin: 0;
            font-size: 2.5em;
        }
        
        .header p {
            color: #666;
            margin: 10px 0 0 0;
            font-size: 1.1em;
        }
        
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            background: #fafafa;
        }
        
        .test-section h3 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 1.3em;
        }
        
        .test-result {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
        }
        
        .test-result.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        
        .test-result.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        
        .test-result.info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        
        .chart-container {
            width: 100%;
            height: 400px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 2px;
            background: white;
            box-sizing: border-box;
        }
        
        .chart-group {
            margin-bottom: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 8px;
            background: #fafafa;
            box-sizing: border-box;
        }
        
        .controls {
            margin: 15px 0;
            text-align: center;
        }
        
        .controls button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 0 5px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .controls button:hover {
            background: #0056b3;
        }
        
        .controls button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        
        .status-panel {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .status-item {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
            padding: 5px 0;
            border-bottom: 1px solid #e9ecef;
        }
        
        .status-item:last-child {
            border-bottom: none;
        }
        
        .status-label {
            font-weight: bold;
            color: #495057;
        }
        
        .status-value {
            color: #6c757d;
            font-family: 'Courier New', monospace;
        }
        
        .log-panel {
            background: #2d3748;
            color: #e2e8f0;
            border-radius: 4px;
            padding: 15px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .log-entry {
            margin: 2px 0;
            padding: 2px 0;
        }
        
        .log-entry.success { color: #68d391; }
        .log-entry.error { color: #fc8181; }
        .log-entry.warn { color: #f6e05e; }
        .log-entry.info { color: #63b3ed; }
        
        .test-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            margin: 0 5px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .test-btn:hover {
            background: #0056b3;
        }
        
        .test-status {
            margin: 10px 0;
            padding: 10px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
        }
        
        /* 多股票相关样式 */
        .test-info {
            font-size: 12px;
            line-height: 1.4;
        }
        
        .test-controls label {
            display: inline-flex;
            align-items: center;
            font-size: 14px;
            color: #495057;
        }
        
        .test-controls input[type="checkbox"] {
            margin-right: 5px;
        }
        
        /* 确保图表容器支持绝对定位的子元素 */
        .test-chart-container {
            position: relative;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🚀 LightWeight Charts V2.1.0</h1>
            <p>核心BaseChart和配置系统测试</p>
        </div>
        
        <!-- 系统检查 -->
        <div class="test-section">
            <h3>🔍 系统组件检查</h3>
            <div id="system-check"></div>
        </div>
        
        <!-- 配置系统测试 -->
        <div class="test-section">
            <h3>⚙️ 配置系统测试</h3>
            <div id="config-test"></div>
        </div>
        
        <!-- BaseChart测试 -->
        <div class="test-section">
            <h3>📊 BaseChart功能测试</h3>
            <div class="chart-container" id="test-chart"></div>
            <div class="controls">
                <button onclick="createTestChart()">创建图表</button>
                <button onclick="addTestSeries()">添加系列</button>
                <button onclick="setTestData()">设置数据</button>
                <button onclick="testTimeRange()">测试时间范围</button>
                <button onclick="destroyTestChart()">销毁图表</button>
            </div>
            <div class="status-panel" id="chart-status"></div>
        </div>
        
        <!-- 事件系统测试 -->
        <div class="test-section">
            <h3>📡 事件系统测试</h3>
            <div class="controls">
                <button onclick="testEventSystem()">测试事件系统</button>
                <button onclick="clearEventLog()">清空日志</button>
            </div>
            <div class="log-panel" id="event-log"></div>
        </div>
        
        <!-- 注册器测试 -->
        <div class="test-section">
            <h3>📋 图表注册器测试</h3>
            <div class="controls">
                <button onclick="testRegistry()">测试注册器</button>
                <button onclick="showRegistryStatus()">显示注册状态</button>
            </div>
            <div class="status-panel" id="registry-status"></div>
        </div>
        
        <!-- MainChart功能测试 -->
        <div class="test-section">
            <h3>📈 MainChart功能测试（单股票）</h3>
            <div class="test-content">
                <div class="chart-group">
                    <div id="main-chart" class="chart-container"></div>
                </div>
                <div class="test-controls">
                    <button onclick="createMainChart()" class="test-btn">创建主图</button>
                    <button onclick="loadMainChartData()" class="test-btn">加载数据</button>
                    <button onclick="clearMainChart()" class="test-btn">清空数据</button>
                    <button onclick="destroyMainChart()" class="test-btn">销毁主图</button>
                </div>
                <div class="test-status" id="mainChartStatus">状态: 未创建</div>
                <div class="test-info" style="margin-top: 10px; padding: 10px; background: #e9ecef; border-radius: 4px; font-size: 12px;">
                    <strong>SuperTrend功能说明：</strong><br>
                    • 多段式显示：上升趋势显示绿色线段，下降趋势显示红色线段<br>
                    • 信号标记：趋势转换时显示箭头和BUY/SELL文字<br>
                    • 买入信号：绿色向上箭头，显示在K线下方<br>
                    • 卖出信号：红色向下箭头，显示在K线上方<br>
                    • 测试股票：HK.09660（包含多个买卖信号）
                </div>
            </div>
        </div>
        
        <!-- 多股票可视化测试 -->
        <div class="test-section">
            <h3>📊 多股票可视化功能测试</h3>
            <div class="test-content">
                <div class="test-chart-container" id="multiStockChartContainer" style="width: 100%; height: 400px; border: 1px solid #ddd; margin: 10px 0; position: relative;"></div>
                <div class="test-controls">
                    <button onclick="createMultiStockChart()" class="test-btn">创建多股票图表</button>
                    <button onclick="loadMultipleStocks()" class="test-btn">加载多股票数据</button>
                    <button onclick="clearMultiStockChart()" class="test-btn">清空数据</button>
                    <button onclick="destroyMultiStockChart()" class="test-btn">销毁图表</button>
                </div>
                <div class="test-controls">
                    <label style="margin-right: 10px;">
                        <input type="checkbox" id="includeIndicators" checked> 包含技术指标
                    </label>
                    <label style="margin-right: 10px;">
                        <input type="checkbox" id="enableNormalization"> 启用价格归一化
                    </label>
                </div>
                <div class="test-status" id="multiStockStatus">状态: 未创建</div>
                <div class="test-info" style="margin-top: 10px; padding: 10px; background: #e9ecef; border-radius: 4px; font-size: 12px;">
                    <strong>多股票SuperTrend功能说明：</strong><br>
                    • 右上角显示股票图例，点击可切换显示/隐藏<br>
                    • 支持价格归一化，便于比较不同价格范围的股票<br>
                    • 每只股票的SuperTrend使用独立的颜色方案<br>
                    • 买卖信号标记在各自股票的K线上<br>
                    • 鼠标悬停显示多股票对比信息<br>
                    • 测试股票：HK.02432, HK.09660（包含不同的趋势模式）
                </div>
            </div>
        </div>
        
        <!-- 成交量子图测试 -->
        <div class="test-section">
            <h3>📊 成交量子图测试</h3>
            <p class="test-info">测试成交量子图的创建、数据加载和时间轴同步功能</p>
            
            <div class="controls">
                <button class="test-btn" onclick="createVolumeTest()">创建主图+成交量子图</button>
                <button class="test-btn" onclick="loadVolumeTestData()">加载测试数据</button>
                <button class="test-btn" onclick="toggleVolumeChart()">切换成交量子图</button>
                <button class="test-btn" onclick="clearVolumeTest()">清空测试</button>
            </div>
            
            <div id="volume-test-status" class="test-status">
                等待测试...
            </div>
            
            <!-- 主图容器 -->
            <div class="chart-group">
                <div id="volume-main-chart" class="chart-container"></div>
            </div>
            
            <!-- 成交量子图会自动添加到这里 -->
            
            <div class="test-result info">
                <strong>测试说明：</strong><br>
                • 成交量子图只显示主股票（第一只股票）的成交量数据<br>
                • 成交量柱状图根据涨跌情况显示不同颜色（绿色上涨，红色下跌）<br>
                • 时间轴与主图自动同步<br>
                • 支持独立的缩放和平移操作
            </div>
        </div>
        
        <!-- Squeeze Momentum子图测试 -->
        <div class="test-section">
            <h3>📊 Squeeze Momentum子图测试</h3>
            <p class="test-info">测试Squeeze Momentum子图的创建、数据加载和时间轴同步功能</p>
            
            <div class="controls">
                <button class="test-btn" onclick="createSqueezeTest()">创建主图+Squeeze子图</button>
                <button class="test-btn" onclick="loadSqueezeTestData()">加载测试数据</button>
                <button class="test-btn" onclick="toggleSqueezeChart()">切换Squeeze子图</button>
                <button class="test-btn" onclick="clearSqueezeTest()">清空测试</button>
            </div>
            
            <div id="squeeze-test-status" class="test-status">
                等待测试...
            </div>
            
            <!-- 主图容器 -->
            <div class="chart-group">
                <div id="squeeze-main-chart" class="chart-container"></div>
            </div>
            
            <!-- Squeeze子图会自动添加到这里 -->
            
            <div class="test-result info">
                <strong>测试说明：</strong><br>
                • Squeeze Momentum子图只显示主股票（第一只股票）的动量数据<br>
                • 动量柱状图根据正负值和变化趋势显示不同颜色<br>
                • 正值：亮绿色（上升）/暗绿色（下降）<br>
                • 负值：亮红色（上升）/暗红色（下降）<br>
                • 零线作为参考基准<br>
                • 时间轴与主图自动同步<br>
                • 支持独立的缩放和平移操作
            </div>
        </div>
    </div>

    <!-- 引入LightweightCharts库 -->
    <script src="https://unpkg.com/lightweight-charts@4.1.3/dist/lightweight-charts.standalone.production.js"></script>
    
    <!-- 引入重构版本 -->
    <script src="/static/lightweight-charts.js"></script>
    
    <script>
        // 全局变量
        let testChart = null;
        let testSeries = null;
        let eventLog = [];
        let testMainChart = null;
        let testMultiStockChart = null;
        
        // 页面加载完成后执行系统检查
        document.addEventListener('DOMContentLoaded', function() {
            // 等待LightweightCharts加载完成
            setTimeout(() => {
                performSystemCheck();
                testConfigSystem();
                setupEventLogging();
                checkLightweightChartsAPI();
            }, 100);
        });
        
        // 系统组件检查
        function performSystemCheck() {
            const checkDiv = document.getElementById('system-check');
            const checks = [
                { name: 'LightweightCharts', obj: window.LightweightCharts, desc: '图表库' },
                { name: 'ChartConfigV2', obj: window.ChartConfigV2, desc: '配置管理' },
                { name: 'ChartUtilsV2', obj: window.ChartUtilsV2, desc: '工具函数' },
                { name: 'EventEmitter', obj: window.EventEmitter, desc: '事件系统' },
                { name: 'ChartRegistry', obj: window.ChartRegistry, desc: '图表注册器' },
                { name: 'BaseChart', obj: window.BaseChart, desc: '基础图表类' },
                { name: 'MainChart', obj: window.MainChart, desc: '主图表类' }
            ];
            
            let html = '';
            checks.forEach(check => {
                const exists = !!check.obj;
                const status = exists ? 'success' : 'error';
                const icon = exists ? '✅' : '❌';
                html += `<div class="test-result ${status}">${icon} ${check.name} (${check.desc}): ${exists ? '已加载' : '未找到'}</div>`;
            });
            
            checkDiv.innerHTML = html;
        }
        
        // 配置系统测试
        function testConfigSystem() {
            const testDiv = document.getElementById('config-test');
            let html = '';
            
            try {
                // 测试配置验证
                const isValid = ChartConfigV2.validate();
                html += `<div class="test-result ${isValid ? 'success' : 'error'}">配置验证: ${isValid ? '通过' : '失败'}</div>`;
                
                // 测试获取不同类型的配置
                const mainConfig = ChartConfigV2.getChartConfig('main');
                const volumeConfig = ChartConfigV2.getChartConfig('volume');
                const indicatorConfig = ChartConfigV2.getChartConfig('indicator');
                
                html += `<div class="test-result success">主图配置: 高度=${mainConfig.height}px</div>`;
                html += `<div class="test-result success">成交量配置: 高度=${volumeConfig.height}px</div>`;
                html += `<div class="test-result success">指标配置: 高度=${indicatorConfig.height}px</div>`;
                
                // 测试颜色配置
                const colors = ChartConfigV2.COLORS;
                html += `<div class="test-result info">颜色配置: 上涨=${colors.UP}, 下跌=${colors.DOWN}</div>`;
                
                // 测试同步配置
                const sync = ChartConfigV2.SYNC;
                html += `<div class="test-result info">同步配置: 节流延迟=${sync.THROTTLE_DELAY}ms</div>`;
                
            } catch (error) {
                html += `<div class="test-result error">配置测试失败: ${error.message}</div>`;
            }
            
            testDiv.innerHTML = html;
        }
        
        // 创建测试图表
        function createTestChart() {
            try {
                // 检查LightweightCharts是否可用
                if (!window.LightweightCharts) {
                    addLog('error', 'LightweightCharts库未加载');
                    return;
                }
                
                const container = document.getElementById('test-chart');
                
                // 清空容器
                container.innerHTML = '';
                
                // 创建BaseChart实例
                testChart = new BaseChart(container, {
                    chartType: 'main',
                    width: container.clientWidth,
                    height: 400
                });
                
                // 监听事件
                testChart.on('created', () => {
                    addLog('success', '图表创建成功');
                    updateChartStatus();
                });
                
                testChart.on('error', (error) => {
                    addLog('error', `图表错误: ${error.message}`);
                    updateChartStatus();
                });
                
                testChart.on('dataLoaded', (data) => {
                    addLog('info', `数据已加载: ${data.length} 条记录`);
                    updateChartStatus();
                });
                
                // 创建图表
                testChart.create();
                
            } catch (error) {
                addLog('error', `创建图表失败: ${error.message}`);
            }
        }
        
        // 添加测试系列
        function addTestSeries() {
            if (!testChart) {
                addLog('warn', '请先创建图表');
                return;
            }
            
            try {
                testSeries = testChart.addSeries('candlestick', {
                    upColor: ChartConfigV2.COLORS.UP,
                    downColor: ChartConfigV2.COLORS.DOWN,
                    borderUpColor: ChartConfigV2.COLORS.UP,
                    borderDownColor: ChartConfigV2.COLORS.DOWN,
                    wickUpColor: ChartConfigV2.COLORS.UP,
                    wickDownColor: ChartConfigV2.COLORS.DOWN
                });
                
                if (testSeries) {
                    addLog('success', '蜡烛图系列添加成功');
                    updateChartStatus();
                } else {
                    addLog('error', '添加系列失败');
                }
            } catch (error) {
                addLog('error', `添加系列失败: ${error.message}`);
            }
        }
        
        // 设置测试数据
        function setTestData() {
            if (!testSeries) {
                addLog('warn', '请先添加系列');
                return;
            }
            
            try {
                // 生成测试数据
                const testData = generateTestData();
                testSeries.setData(testData);
                
                addLog('success', `测试数据设置成功: ${testData.length} 条记录`);
                updateChartStatus();
                
                // 适配内容
                setTimeout(() => {
                    testChart.fitContentToData();
                }, 100);
                
            } catch (error) {
                addLog('error', `设置数据失败: ${error.message}`);
            }
        }
        
        // 测试时间范围
        function testTimeRange() {
            if (!testChart) {
                addLog('warn', '请先创建图表并设置数据');
                return;
            }
            
            try {
                // 获取当前时间范围
                const currentRange = testChart.getTimeRange();
                if (currentRange) {
                    addLog('info', `当前时间范围: ${new Date(currentRange.from * 1000).toLocaleString()} - ${new Date(currentRange.to * 1000).toLocaleString()}`);
                    
                    // 设置新的时间范围（缩放到中间部分）
                    const duration = currentRange.to - currentRange.from;
                    const newRange = {
                        from: currentRange.from + duration * 0.25,
                        to: currentRange.to - duration * 0.25
                    };
                    
                    testChart.setTimeRange(newRange);
                    addLog('success', '时间范围设置成功');
                } else {
                    addLog('warn', '无法获取时间范围');
                }
            } catch (error) {
                addLog('error', `时间范围测试失败: ${error.message}`);
            }
        }
        
        // 销毁测试图表
        function destroyTestChart() {
            if (testChart) {
                testChart.destroy();
                testChart = null;
                testSeries = null;
                addLog('success', '图表已销毁');
                updateChartStatus();
            } else {
                addLog('warn', '没有图表需要销毁');
            }
        }
        
        // 测试事件系统
        function testEventSystem() {
            try {
                const emitter = new EventEmitter();
                
                // 测试基本事件
                emitter.on('test', (data) => {
                    addLog('success', `事件接收: ${data}`);
                });
                
                emitter.emit('test', 'Hello World!');
                
                // 测试一次性事件
                emitter.once('once-test', (data) => {
                    addLog('info', `一次性事件: ${data}`);
                });
                
                emitter.emit('once-test', 'First');
                emitter.emit('once-test', 'Second'); // 这个不会触发
                
                // 测试链式调用
                emitter.on('chain1', () => addLog('success', '链式事件1'))
                       .on('chain2', () => addLog('success', '链式事件2'));
                
                emitter.emit('chain1');
                emitter.emit('chain2');
                
                addLog('success', '事件系统测试完成');
                
            } catch (error) {
                addLog('error', `事件系统测试失败: ${error.message}`);
            }
        }
        
        // 测试注册器
        function testRegistry() {
            try {
                // 创建测试图表
                const testContainer = document.createElement('div');
                const chart1 = new BaseChart(testContainer, { chartType: 'main' });
                const chart2 = new BaseChart(testContainer, { chartType: 'volume' });
                
                // 注册主图表
                ChartRegistry.register(chart1.id, chart1, true);
                
                addLog('success', `图表注册测试完成，总数: ${ChartRegistry.getChartCount()}`);
                addLog('info', `主图表ID: ${ChartRegistry.getMainChart()?.id}`);
                
                // 清理
                chart1.destroy();
                chart2.destroy();
                
            } catch (error) {
                addLog('error', `注册器测试失败: ${error.message}`);
            }
        }
        
        // 显示注册器状态
        function showRegistryStatus() {
            const statusDiv = document.getElementById('registry-status');
            const charts = ChartRegistry.getAllCharts();
            const mainChart = ChartRegistry.getMainChart();
            
            let html = `
                <div class="status-item">
                    <span class="status-label">图表总数:</span>
                    <span class="status-value">${ChartRegistry.getChartCount()}</span>
                </div>
                <div class="status-item">
                    <span class="status-label">主图表:</span>
                    <span class="status-value">${mainChart ? mainChart.id : '无'}</span>
                </div>
            `;
            
            charts.forEach((chart, index) => {
                const info = chart.getInfo();
                html += `
                    <div class="status-item">
                        <span class="status-label">图表${index + 1}:</span>
                        <span class="status-value">${info.id} (${info.type})</span>
                    </div>
                `;
            });
            
            statusDiv.innerHTML = html;
        }
        
        // 更新图表状态
        function updateChartStatus() {
            const statusDiv = document.getElementById('chart-status');
            
            if (!testChart) {
                statusDiv.innerHTML = '<div class="status-item"><span class="status-label">状态:</span><span class="status-value">无图表</span></div>';
                return;
            }
            
            const info = testChart.getInfo();
            const state = testChart.getState();
            
            let html = `
                <div class="status-item">
                    <span class="status-label">图表ID:</span>
                    <span class="status-value">${info.id}</span>
                </div>
                <div class="status-item">
                    <span class="status-label">类型:</span>
                    <span class="status-value">${info.type}</span>
                </div>
                <div class="status-item">
                    <span class="status-label">系列数量:</span>
                    <span class="status-value">${info.seriesCount}</span>
                </div>
                <div class="status-item">
                    <span class="status-label">数据已加载:</span>
                    <span class="status-value">${state.isDataLoaded ? '是' : '否'}</span>
                </div>
                <div class="status-item">
                    <span class="status-label">已对齐:</span>
                    <span class="status-value">${state.isAligned ? '是' : '否'}</span>
                </div>
                <div class="status-item">
                    <span class="status-label">有错误:</span>
                    <span class="status-value">${state.hasError ? '是' : '否'}</span>
                </div>
            `;
            
            if (state.hasError && state.errorMessage) {
                html += `
                    <div class="status-item">
                        <span class="status-label">错误信息:</span>
                        <span class="status-value">${state.errorMessage}</span>
                    </div>
                `;
            }
            
            statusDiv.innerHTML = html;
        }
        
        // 设置事件日志
        function setupEventLogging() {
            // 重写console方法以捕获日志
            const originalLog = console.log;
            const originalError = console.error;
            const originalWarn = console.warn;
            
            console.log = function(...args) {
                originalLog.apply(console, args);
                if (args[0] && typeof args[0] === 'string' && args[0].includes('📊')) {
                    addLog('info', args.join(' '));
                }
            };
            
            console.error = function(...args) {
                originalError.apply(console, args);
                if (args[0] && typeof args[0] === 'string' && args[0].includes('❌')) {
                    addLog('error', args.join(' '));
                }
            };
            
            console.warn = function(...args) {
                originalWarn.apply(console, args);
                if (args[0] && typeof args[0] === 'string') {
                    addLog('warn', args.join(' '));
                }
            };
        }
        
        // 添加日志
        function addLog(type, message) {
            const timestamp = new Date().toLocaleTimeString();
            eventLog.push({ type, message, timestamp });
            
            // 限制日志数量
            if (eventLog.length > 50) {
                eventLog.shift();
            }
            
            updateEventLog();
        }
        
        // 更新事件日志显示
        function updateEventLog() {
            const logDiv = document.getElementById('event-log');
            let html = '';
            
            eventLog.forEach(log => {
                html += `<div class="log-entry ${log.type}">[${log.timestamp}] ${log.message}</div>`;
            });
            
            logDiv.innerHTML = html;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        // 清空事件日志
        function clearEventLog() {
            eventLog = [];
            updateEventLog();
        }
        
        // 生成测试数据
        function generateTestData() {
            const data = [];
            const startTime = Math.floor(Date.now() / 1000) - 86400 * 30; // 30天前
            let price = 100;
            
            for (let i = 0; i < 100; i++) {
                const time = startTime + i * 86400; // 每天一个数据点
                const change = (Math.random() - 0.5) * 4; // -2 到 +2 的随机变化
                price += change;
                
                const open = price;
                const close = price + (Math.random() - 0.5) * 2;
                const high = Math.max(open, close) + Math.random() * 1;
                const low = Math.min(open, close) - Math.random() * 1;
                
                data.push({
                    time: time,
                    open: parseFloat(open.toFixed(2)),
                    high: parseFloat(high.toFixed(2)),
                    low: parseFloat(low.toFixed(2)),
                    close: parseFloat(close.toFixed(2))
                });
                
                price = close;
            }
            
            return data;
        }
        
        // MainChart测试函数
        function createMainChart() {
            try {
                const container = document.getElementById('main-chart');
                if (!container) {
                    updateStatus('mainChartStatus', '❌ 容器不存在');
                    return;
                }

                // 清空容器
                container.innerHTML = '';

                // 创建主图
                testMainChart = new MainChart(container);
                testMainChart.create();

                updateStatus('mainChartStatus', '✅ 主图创建成功');
                addLog('MainChart 创建成功', 'success');

            } catch (error) {
                updateStatus('mainChartStatus', `❌ 创建失败: ${error.message}`);
                addLog(`MainChart 创建失败: ${error.message}`, 'error');
            }
        }

        function loadMainChartData() {
            if (!testMainChart) {
                updateStatus('mainChartStatus', '❌ 请先创建主图');
                return;
            }

            try {
                // 测试数据加载
                const codes = ['HK.09660']; // 测试股票代码（使用实际存在的数据）
                const indicators = ['supertrend']; // 重点测试SuperTrend指标

                testMainChart.loadData(codes, indicators)
                    .then(() => {
                        updateStatus('mainChartStatus', '✅ 数据加载成功');
                        addLog('MainChart 数据加载成功', 'success');
                    })
                    .catch(error => {
                        updateStatus('mainChartStatus', `❌ 数据加载失败: ${error.message}`);
                        addLog(`MainChart 数据加载失败: ${error.message}`, 'error');
                    });

                updateStatus('mainChartStatus', '⏳ 正在加载数据...');

            } catch (error) {
                updateStatus('mainChartStatus', `❌ 加载失败: ${error.message}`);
                addLog(`MainChart 数据加载失败: ${error.message}`, 'error');
            }
        }

        // 多股票图表测试函数
        function createMultiStockChart() {
            try {
                const container = document.getElementById('multiStockChartContainer');
                if (!container) {
                    updateStatus('multiStockStatus', '❌ 容器不存在');
                    return;
                }

                // 清空容器
                container.innerHTML = '';

                // 创建多股票主图
                testMultiStockChart = new MainChart(container);
                testMultiStockChart.create();

                updateStatus('multiStockStatus', '✅ 多股票图表创建成功');
                addLog('多股票图表创建成功', 'success');

            } catch (error) {
                updateStatus('multiStockStatus', `❌ 创建失败: ${error.message}`);
                addLog(`多股票图表创建失败: ${error.message}`, 'error');
            }
        }

        function loadMultipleStocks() {
            if (!testMultiStockChart) {
                updateStatus('multiStockStatus', '❌ 请先创建多股票图表');
                return;
            }

            try {
                // 获取指标选择
                const includeIndicators = document.getElementById('includeIndicators').checked;
                const indicators = includeIndicators ? ['supertrend'] : []; // 重点测试SuperTrend指标
                
                // 多股票测试数据
                const codes = ['HK.02432', 'HK.09660', 'HK.01810']; // 测试多个股票代码
                
                updateStatus('multiStockStatus', '⏳ 正在加载多股票数据...');
                addLog('开始加载多股票数据', 'info');

                testMultiStockChart.loadData(codes, indicators)
                    .then(() => {
                        updateStatus('multiStockStatus', '✅ 多股票数据加载成功');
                        addLog('多股票数据加载成功', 'success');
                        addLog('右上角显示股票图例，可点击切换显示/隐藏', 'info');
                        
                        // 检查归一化选项
                        const enableNormalization = document.getElementById('enableNormalization').checked;
                        if (enableNormalization && testMultiStockChart.toggleNormalization) {
                            setTimeout(() => {
                                testMultiStockChart.toggleNormalization();
                                addLog('已启用价格归一化，便于比较不同价格范围的股票', 'info');
                            }, 500);
                        }
                    })
                    .catch(error => {
                        updateStatus('multiStockStatus', `❌ 多股票数据加载失败: ${error.message}`);
                        addLog(`多股票数据加载失败: ${error.message}`, 'error');
                    });

            } catch (error) {
                updateStatus('multiStockStatus', `❌ 加载失败: ${error.message}`);
                addLog(`多股票数据加载失败: ${error.message}`, 'error');
            }
        }

        function clearMultiStockChart() {
            if (!testMultiStockChart) {
                updateStatus('multiStockStatus', '❌ 请先创建多股票图表');
                return;
            }

            try {
                testMultiStockChart.clearData();
                updateStatus('multiStockStatus', '✅ 多股票数据已清空');
                addLog('多股票数据已清空', 'success');

            } catch (error) {
                updateStatus('multiStockStatus', `❌ 清空失败: ${error.message}`);
                addLog(`多股票数据清空失败: ${error.message}`, 'error');
            }
        }

        function destroyMultiStockChart() {
            if (!testMultiStockChart) {
                updateStatus('multiStockStatus', '❌ 多股票图表不存在');
                return;
            }

            try {
                testMultiStockChart.destroy();
                testMultiStockChart = null;
                
                // 清空容器
                const container = document.getElementById('multiStockChartContainer');
                if (container) {
                    container.innerHTML = '';
                }

                updateStatus('multiStockStatus', '✅ 多股票图表已销毁');
                addLog('多股票图表已销毁', 'success');

            } catch (error) {
                updateStatus('multiStockStatus', `❌ 销毁失败: ${error.message}`);
                addLog(`多股票图表销毁失败: ${error.message}`, 'error');
            }
        }

        function clearMainChart() {
            if (!testMainChart) {
                updateStatus('mainChartStatus', '❌ 请先创建主图');
                return;
            }

            try {
                testMainChart.clearData();
                updateStatus('mainChartStatus', '✅ 数据已清空');
                addLog('MainChart 数据已清空', 'success');

            } catch (error) {
                updateStatus('mainChartStatus', `❌ 清空失败: ${error.message}`);
                addLog(`MainChart 清空失败: ${error.message}`, 'error');
            }
        }

        function destroyMainChart() {
            if (!testMainChart) {
                updateStatus('mainChartStatus', '❌ 主图不存在');
                return;
            }

            try {
                testMainChart.destroy();
                testMainChart = null;
                
                // 清空容器
                const container = document.getElementById('main-chart');
                if (container) {
                    container.innerHTML = '';
                }

                updateStatus('mainChartStatus', '✅ 主图已销毁');
                addLog('MainChart 已销毁', 'success');

            } catch (error) {
                updateStatus('mainChartStatus', `❌ 销毁失败: ${error.message}`);
                addLog(`MainChart 销毁失败: ${error.message}`, 'error');
            }
        }
        
        // 更新状态显示的辅助函数
        function updateStatus(elementId, message) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = message;
            }
        }
        
        // 检查LightweightCharts API
        function checkLightweightChartsAPI() {
            if (window.LightweightCharts) {
                addLog('success', `LightweightCharts版本: ${window.LightweightCharts.version || '未知'}`);
                addLog('info', `createChart方法: ${typeof window.LightweightCharts.createChart}`);
                
                // 测试创建一个临时图表来检查API
                try {
                    const tempContainer = document.createElement('div');
                    tempContainer.style.width = '100px';
                    tempContainer.style.height = '100px';
                    document.body.appendChild(tempContainer);
                    
                    const tempChart = window.LightweightCharts.createChart(tempContainer, {
                        width: 100,
                        height: 100
                    });
                    
                    addLog('info', `图表方法检查: addCandlestickSeries=${typeof tempChart.addCandlestickSeries}, addLineSeries=${typeof tempChart.addLineSeries}`);
                    
                    // 清理
                    tempChart.remove();
                    document.body.removeChild(tempContainer);
                    
                } catch (error) {
                    addLog('error', `LightweightCharts API测试失败: ${error.message}`);
                }
            } else {
                addLog('error', 'LightweightCharts未加载');
            }
        }

        // ================================
        // 成交量子图测试
        // ================================
        let volumeMainChart = null;
        let volumeTestContainer = null;
        
        function updateVolumeTestStatus(message, type = 'info') {
            const statusDiv = document.getElementById('volume-test-status');
            statusDiv.textContent = message;
            statusDiv.className = `test-status ${type}`;
            addLog(`[成交量测试] ${message}`, type);
        }
        
        async function createVolumeTest() {
            try {
                updateVolumeTestStatus('正在创建主图和成交量子图...', 'info');
                
                // 清理现有测试
                if (volumeMainChart) {
                    volumeMainChart.destroy();
                    volumeMainChart = null;
                }
                
                // 获取主图容器
                const mainContainer = document.getElementById('volume-main-chart');
                mainContainer.innerHTML = '';
                
                // 创建主图
                volumeMainChart = new MainChart(mainContainer);
                volumeMainChart.create();
                
                // 创建成交量子图
                volumeTestContainer = mainContainer.parentElement;
                volumeMainChart.createVolumeSubChart(volumeTestContainer);
                
                updateVolumeTestStatus('主图和成交量子图创建完成', 'success');
                
            } catch (error) {
                console.error('创建成交量测试失败:', error);
                updateVolumeTestStatus('创建失败: ' + error.message, 'error');
            }
        }
        
        async function loadVolumeTestData() {
            if (!volumeMainChart) {
                updateVolumeTestStatus('请先创建图表', 'error');
                return;
            }
            
            try {
                updateVolumeTestStatus('正在加载测试数据...', 'info');
                
                // 加载单只股票数据（用于测试成交量）
                const codes = ['HK.01810']; // 只加载一只股票
                const indicators = ['supertrend', 'ma5'];
                
                await volumeMainChart.loadData(codes, indicators);
                
                updateVolumeTestStatus('测试数据加载完成，成交量子图已同步', 'success');
                
            } catch (error) {
                console.error('加载成交量测试数据失败:', error);
                updateVolumeTestStatus('数据加载失败: ' + error.message, 'error');
            }
        }
        
        function toggleVolumeChart() {
            if (!volumeMainChart) {
                updateVolumeTestStatus('请先创建图表', 'error');
                return;
            }
            
            try {
                if (volumeMainChart.volumeChart) {
                    // 销毁成交量子图
                    volumeMainChart.destroyVolumeSubChart();
                    updateVolumeTestStatus('成交量子图已隐藏', 'info');
                } else {
                    // 重新创建成交量子图
                    volumeMainChart.createVolumeSubChart(volumeTestContainer);
                    // 如果有数据，重新加载
                    if (volumeMainChart.stockInfos.length > 0) {
                        setTimeout(() => {
                            volumeMainChart.loadVolumeDataToSubChart();
                        }, 100);
                    }
                    updateVolumeTestStatus('成交量子图已显示', 'success');
                }
            } catch (error) {
                console.error('切换成交量子图失败:', error);
                updateVolumeTestStatus('切换失败: ' + error.message, 'error');
            }
        }
        
        function clearVolumeTest() {
            try {
                if (volumeMainChart) {
                    volumeMainChart.destroy();
                    volumeMainChart = null;
                }
                
                const mainContainer = document.getElementById('volume-main-chart');
                mainContainer.innerHTML = '';
                
                // 清理可能残留的成交量容器
                const volumeContainer = document.getElementById('volume-chart-container');
                if (volumeContainer && volumeContainer.parentNode) {
                    volumeContainer.parentNode.removeChild(volumeContainer);
                }
                
                updateVolumeTestStatus('测试已清空', 'info');
                
            } catch (error) {
                console.error('清空成交量测试失败:', error);
                updateVolumeTestStatus('清空失败: ' + error.message, 'error');
            }
        }

        // ================================
        // Squeeze Momentum子图测试
        // ================================
        let squeezeMainChart = null;
        let squeezeTestContainer = null;
        
        function updateSqueezeTestStatus(message, type = 'info') {
            const statusDiv = document.getElementById('squeeze-test-status');
            statusDiv.textContent = message;
            statusDiv.className = `test-status ${type}`;
            addLog(`[Squeeze测试] ${message}`, type);
        }
        
        async function createSqueezeTest() {
            try {
                updateSqueezeTestStatus('正在创建主图和Squeeze子图...', 'info');
                
                // 清理现有测试
                if (squeezeMainChart) {
                    squeezeMainChart.destroy();
                    squeezeMainChart = null;
                }
                
                // 获取主图容器
                const mainContainer = document.getElementById('squeeze-main-chart');
                mainContainer.innerHTML = '';
                
                // 创建主图
                squeezeMainChart = new MainChart(mainContainer);
                squeezeMainChart.create();
                
                // 创建Squeeze子图
                squeezeTestContainer = mainContainer.parentElement;
                squeezeMainChart.createSqueezeSubChart(squeezeTestContainer);
                
                updateSqueezeTestStatus('主图和Squeeze子图创建完成', 'success');
                
            } catch (error) {
                console.error('创建Squeeze测试失败:', error);
                updateSqueezeTestStatus('创建失败: ' + error.message, 'error');
            }
        }
        
        async function loadSqueezeTestData() {
            if (!squeezeMainChart) {
                updateSqueezeTestStatus('请先创建图表', 'error');
                return;
            }
            
            try {
                updateSqueezeTestStatus('正在加载测试数据...', 'info');
                
                // 加载单只股票数据（用于测试Squeeze）
                const codes = ['HK.01810']; // 只加载一只股票
                const indicators = ['supertrend', 'ma5'];
                
                await squeezeMainChart.loadData(codes, indicators);
                
                updateSqueezeTestStatus('测试数据加载完成，Squeeze子图已同步', 'success');
                
            } catch (error) {
                console.error('加载Squeeze测试数据失败:', error);
                updateSqueezeTestStatus('数据加载失败: ' + error.message, 'error');
            }
        }
        
        function toggleSqueezeChart() {
            if (!squeezeMainChart) {
                updateSqueezeTestStatus('请先创建图表', 'error');
                return;
            }
            
            try {
                if (squeezeMainChart.squeezeChart) {
                    // 销毁Squeeze子图
                    squeezeMainChart.destroySqueezeSubChart();
                    updateSqueezeTestStatus('Squeeze子图已隐藏', 'info');
                } else {
                    // 重新创建Squeeze子图
                    squeezeMainChart.createSqueezeSubChart(squeezeTestContainer);
                    // 如果有数据，重新加载
                    if (squeezeMainChart.stockInfos.length > 0) {
                        setTimeout(() => {
                            squeezeMainChart.loadSqueezeDataToSubChart();
                        }, 100);
                    }
                    updateSqueezeTestStatus('Squeeze子图已显示', 'success');
                }
            } catch (error) {
                console.error('切换Squeeze子图失败:', error);
                updateSqueezeTestStatus('切换失败: ' + error.message, 'error');
            }
        }
        
        function clearSqueezeTest() {
            try {
                if (squeezeMainChart) {
                    squeezeMainChart.destroy();
                    squeezeMainChart = null;
                }
                
                const mainContainer = document.getElementById('squeeze-main-chart');
                mainContainer.innerHTML = '';
                
                // 清理可能残留的Squeeze容器
                const squeezeContainer = document.getElementById('squeeze-chart-container');
                if (squeezeContainer && squeezeContainer.parentNode) {
                    squeezeContainer.parentNode.removeChild(squeezeContainer);
                }
                
                updateSqueezeTestStatus('测试已清空', 'info');
                
            } catch (error) {
                console.error('清空Squeeze测试失败:', error);
                updateSqueezeTestStatus('清空失败: ' + error.message, 'error');
            }
        }
    </script>
</body>
</html> 