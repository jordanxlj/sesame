<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>SuperTrend Chart</title>
    <script src="/static/lightweight-charts.standalone.production.js"></script>
    <script src="/static/lightweight-charts.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <style>
        #chart { width: 1000px; height: 400px; }
        #volume-chart { width: 1000px; height: 200px; margin-top: 8px; }
        body { font-family: Arial, sans-serif; }
        .form-bar { margin-bottom: 16px; }
        label { margin-right: 8px; }
        button { 
            padding: 6px 12px; 
            margin-left: 10px; 
            border: 1px solid #ccc; 
            border-radius: 4px; 
            background-color: #f8f9fa; 
            cursor: pointer; 
        }
        button:hover { 
            background-color: #e9ecef; 
        }
        button:active { 
            background-color: #dee2e6; 
        }
        .fit-data-btn {
            background-color: #28a745;
            color: white;
            border-color: #28a745;
        }
        .fit-data-btn:hover {
            background-color: #218838;
            border-color: #1e7e34;
        }
        .indicator {
            margin-right: 4px;
        }
        .form-bar label {
            display: inline-flex;
            align-items: center;
            margin-right: 12px;
        }
        .loading-indicator {
            display: none;
            color: #007bff;
            font-style: italic;
            margin-left: 10px;
        }
    </style>
</head>
<body>
    <div class="form-bar">
        <label for="code">股票代码:</label>
        <select id="code" multiple="multiple" style="width:300px">
            <option value="HK.09660">HK.09660 - HORIZON ROBOTICS</option>
            <option value="09660.HK">09660.HK - HORIZON ROBOTICS</option>
        </select>
        <label>指标:</label>
        <label><input type="checkbox" class="indicator" value="supertrend" checked>SuperTrend</label>
        <label><input type="checkbox" class="indicator" value="ma5">MA5</label>
        <label><input type="checkbox" class="indicator" value="ma10">MA10</label>
        <label><input type="checkbox" class="indicator" value="squeeze_momentum">Squeeze Momentum</label>
        <button onclick="forceSyncCharts()">强制同步</button>
        <button onclick="fitChartsToData()" class="fit-data-btn" title="自动适配图表到实际数据范围，消除无效留白">适配数据范围</button>
        <span id="loading-indicator" class="loading-indicator">正在加载图表...</span>
    </div>
    <div id="info-bar" style="font-size:16px; margin-bottom:8px;"></div>
    <div id="chart"></div>
    <div id="volume-chart"></div>
    <script>
        // ===== 全局变量 =====
        let chartManager = null;
        window.chartManager = null; // 确保全局可访问
        let loadTimeout = null; // 防抖定时器
        
        // ===== 初始化 =====
        $(document).ready(function() {
            // 初始化图表管理器
            chartManager = new ChartManager();
            window.chartManager = chartManager;
            
            // 初始化股票代码选择器
            $('#code').select2({
                placeholder: '请选择股票代码',
                allowClear: true
            });
            
            // 监听股票代码变化
            $('#code').on('change', function() {
                autoLoadChart();
            });
            
            // 监听指标变化
            $('.indicator').on('change', function() {
                autoLoadChart();
            });
            
            // 动态加载股票列表
            loadStockOptions();
        });
        
        // ===== 加载股票选项 =====
        function loadStockOptions() {
            fetch('/api/stocks')
                .then(response => response.json())
                .then(stocks => {
                    const select = $('#code');
                    select.empty(); // 清空现有选项
                    
                    stocks.forEach(stock => {
                        const option = new Option(`${stock.code} - ${stock.name}`, stock.code, false, false);
                        select.append(option);
                    });
                    
                    select.trigger('change'); // 通知select2更新
                    
                    // 如果有默认选择，自动加载图表
                    setTimeout(() => {
                        const currentSelection = select.val();
                        if (currentSelection && currentSelection.length > 0) {
                            console.log('检测到默认选择，自动加载图表:', currentSelection);
                            autoLoadChart();
                        }
                    }, 100);
                })
                .catch(error => {
                    console.error('加载股票列表失败:', error);
                    // 如果加载失败，保留默认选项，并尝试自动加载
                    setTimeout(() => {
                        const select = $('#code');
                        const currentSelection = select.val();
                        if (currentSelection && currentSelection.length > 0) {
                            console.log('使用默认选项，自动加载图表:', currentSelection);
                            autoLoadChart();
                        }
                    }, 100);
                });
        }
        
        // ===== 自动加载函数 =====
        function autoLoadChart() {
            // 清除之前的定时器，实现防抖
            if (loadTimeout) {
                clearTimeout(loadTimeout);
            }
            
            // 延迟执行，避免频繁触发
            loadTimeout = setTimeout(() => {
                const codes = $('#code').val();
                
                // 如果没有选择股票代码，清空图表
                if (!codes || codes.length === 0) {
                    clearChart();
                    return;
                }
                
                loadChart();
            }, 300); // 300ms防抖延迟
        }
        
        // ===== 清空图表函数 =====
        function clearChart() {
            if (chartManager) {
                chartManager.destroy();
                chartManager = new ChartManager();
                window.chartManager = chartManager;
            }
            
            // 清空信息栏
            document.getElementById('info-bar').innerText = '';
            console.log('图表已清空');
        }
        
        // ===== 图表加载函数 =====
        async function loadChart() {
            const codes = $('#code').val();
            if (!codes || codes.length === 0) {
                console.log('没有选择股票代码，跳过加载');
                hideLoadingIndicator();
                return;
            }
            
            const selectedIndicators = [];
            $('.indicator:checked').each(function() {
                selectedIndicators.push($(this).val());
            });
            
            console.log('开始加载图表:', { codes, selectedIndicators });
            
            // 显示加载指示器
            showLoadingIndicator();
            
            // 销毁现有图表
            if (chartManager) {
                chartManager.destroy();
            }
            
            // 重新创建图表管理器
            chartManager = new ChartManager();
            window.chartManager = chartManager;
            
            // 创建主图
            const mainChart = chartManager.createMainChart(document.getElementById('chart'));
            
            // 加载数据
            try {
                await chartManager.loadData(codes, selectedIndicators);
                hideLoadingIndicator();
                console.log('图表加载完成');
            } catch (error) {
                hideLoadingIndicator();
                console.error('图表加载失败:', error);
            }
        }
        
        // ===== 加载指示器函数 =====
        function showLoadingIndicator() {
            const indicator = document.getElementById('loading-indicator');
            if (indicator) {
                indicator.style.display = 'inline';
            }
        }
        
        function hideLoadingIndicator() {
            const indicator = document.getElementById('loading-indicator');
            if (indicator) {
                indicator.style.display = 'none';
            }
        }
        
        // ===== 兼容性支持 =====
        // 保持与原有代码的兼容性
        window.mainChart = null;
        window.squeezeChart = null;
        window.squeezeChartInstance = null;
        
        // 当主图创建时更新全局变量
        const originalCreateMainChart = ChartManager.prototype.createMainChart;
        ChartManager.prototype.createMainChart = function(container) {
            const result = originalCreateMainChart.call(this, container);
            window.mainChart = result.chart;
            return result;
        };
    </script>
</body>
</html> 