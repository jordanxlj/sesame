<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>SuperTrend Chart</title>
    <script src="/static/lightweight-charts.standalone.production.js"></script>
    <style>
        #chart { width: 1000px; height: 400px; }
        #volume-chart { width: 1000px; height: 200px; margin-top: 8px; }
        body { font-family: Arial, sans-serif; }
        .form-bar { margin-bottom: 16px; }
        label { margin-right: 8px; }
    </style>
</head>
<body>
    <div class="form-bar">
        <label for="code">股票代码:</label>
        <input id="code" value="HK.09660">
        <label for="indicator">指标:</label>
        <select id="indicator">
            <option value="supertrend">SuperTrend</option>
        </select>
        <button onclick="loadChart()">查询</button>
    </div>
    <div id="chart"></div>
    <div id="volume-chart"></div>
    <script>
        let chart, candleSeries, volumeSeries;
        function loadChart() {
            document.getElementById('chart').innerHTML = '';

            // 创建主图
            chart = LightweightCharts.createChart(document.getElementById('chart'), {
                width: 1000,
                height: 600,
                rightPriceScale: { visible: true },
                leftPriceScale: { visible: false }
            });

            // K线（主轴，默认右侧）
            candleSeries = chart.addCandlestickSeries({
                priceScaleId: 'right',
                scaleMargins: { top: 0.2, bottom: 0.3 } // 上下留白，避免和成交量重叠
            });

            // 成交量（底部副轴）
            volumeSeries = chart.addHistogramSeries({
                priceScaleId: 'volume', // 独立副轴
                priceFormat: { type: 'volume' },
                scaleMargins: { top: 0.8, bottom: 0 }, // 只占底部20%
                color: '#26a69a'
            });

            // 设置成交量副轴参数
            chart.priceScale('volume').applyOptions({
                scaleMargins: { top: 0.8, bottom: 0 },
                alignLabels: true,
                borderVisible: true
            });

            fetch(`/api/kline?code=${document.getElementById('code').value}`).then(r => r.json()).then(ohlc => {
                candleSeries.setData(ohlc);

                // 检查 volume 字段
                if (!ohlc.length || ohlc[0].volume === undefined) {
                    alert('后端未返回 volume 字段，无法显示成交量副图！');
                    return;
                }

                // 成交量数据
                const volumeData = ohlc.map(bar => ({
                    time: bar.time,
                    value: Number(bar.volume),
                    color: bar.close >= bar.open ? '#26a69a' : '#ef5350'
                }));
                volumeSeries.setData(volumeData);
            });

            fetch(`/api/indicator?code=${document.getElementById('code').value}&type=${document.getElementById('indicator').value}`)
            .then(r => r.json()).then(ind => {
                // 分段变色不断线：多根LineSeries分段渲染
                let segments = [];
                let current = [];
                let lastTrend = null;
                ind.forEach((item, idx) => {
                    if (item.supertrend === null || isNaN(item.supertrend)) {
                        if (current.length) {
                            segments.push({ trend: lastTrend, data: current });
                            current = [];
                        }
                        lastTrend = null;
                        return;
                    }
                    if (item.trend !== lastTrend && current.length) {
                        segments.push({ trend: lastTrend, data: current });
                        current = [];
                    }
                    current.push({ time: item.time, value: item.supertrend });
                    lastTrend = item.trend;
                });
                if (current.length) {
                    segments.push({ trend: lastTrend, data: current });
                }
                // 每段用一根线
                segments.forEach(seg => {
                    chart.addLineSeries({
                        color: seg.trend === 1 ? 'green' : 'red',
                        lineWidth: 2
                    }).setData(seg.data);
                });

                // 买卖信号点
                const buyMarkers = ind.filter(item => item.buy === 1)
                    .map(item => ({ time: item.time, position: 'belowBar', color: 'green', shape: 'arrowUp', text: 'Buy' }));
                const sellMarkers = ind.filter(item => item.sell === 1)
                    .map(item => ({ time: item.time, position: 'aboveBar', color: 'red', shape: 'arrowDown', text: 'Sell' }));
                candleSeries.setMarkers([...buyMarkers, ...sellMarkers]);
            });
        }
        loadChart();
    </script>
</body>
</html> 