<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>SuperTrend Chart</title>
    <script src="/static/lightweight-charts.standalone.production.js"></script>
    <script src="/static/lightweight-charts.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <style>
        #chart { width: 1000px; height: 400px; }
        #volume-chart { width: 1000px; height: 200px; margin-top: 8px; }
        body { font-family: Arial, sans-serif; }
        .form-bar { margin-bottom: 16px; }
        label { margin-right: 8px; }
        button { 
            padding: 6px 12px; 
            margin-left: 10px; 
            border: 1px solid #ccc; 
            border-radius: 4px; 
            background-color: #f8f9fa; 
            cursor: pointer; 
        }
        button:hover { 
            background-color: #e9ecef; 
        }
        button:active { 
            background-color: #dee2e6; 
        }
        .reset-btn {
            background-color: #17a2b8;
            color: white;
            border-color: #17a2b8;
            font-weight: 500;
        }
        .reset-btn:hover {
            background-color: #138496;
            border-color: #117a8b;
        }
        .indicator {
            margin-right: 4px;
        }
        .form-bar label {
            display: inline-flex;
            align-items: center;
            margin-right: 12px;
        }
        .loading-indicator {
            display: none;
            color: #007bff;
            font-style: italic;
            margin-left: 10px;
        }
    </style>
</head>
<body>
    <div class="form-bar">
        <label for="code">股票代码:</label>
        <select id="code" multiple="multiple" style="width:300px">
            <option value="HK.09660">HK.09660 - HORIZON ROBOTICS</option>
            <option value="09660.HK">09660.HK - HORIZON ROBOTICS</option>
        </select>
        <label>指标:</label>
        <label><input type="checkbox" class="indicator" value="supertrend" checked>SuperTrend</label>
        <label><input type="checkbox" class="indicator" value="ma5">MA5</label>
        <label><input type="checkbox" class="indicator" value="ma10">MA10</label>
        <label><input type="checkbox" class="indicator" value="squeeze_momentum">Squeeze Momentum</label>
        <button onclick="resetCharts()" class="reset-btn" title="重置图表：强制同步所有图表并适配到实际数据范围">重置图表</button>
        <span id="loading-indicator" class="loading-indicator">正在加载图表...</span>
    </div>
    <div id="info-bar" style="font-size:16px; margin-bottom:8px;"></div>
    <div id="chart"></div>
    <div id="volume-chart"></div>
    <script>
        // ===== 全局变量 =====
        let chartManager = null;
        window.chartManager = null; // 确保全局可访问
        let loadTimeout = null; // 防抖定时器
        
        // ===== 初始化 =====
        $(document).ready(function() {
            // 初始化图表管理器
            chartManager = new ChartManager();
            window.chartManager = chartManager;
            
            // 初始化股票代码选择器
            $('#code').select2({
                placeholder: '请选择股票代码',
                allowClear: true
            });
            
            // 监听股票代码变化
            $('#code').on('change', function() {
                autoLoadChart();
            });
            
            // 监听指标变化
            $('.indicator').on('change', function() {
                autoLoadChart();
            });
            
            // 动态加载股票列表
            loadStockOptions();
        });
        
        // ===== 加载股票选项 =====
        function loadStockOptions() {
            fetch('/api/stocks')
                .then(response => response.json())
                .then(stocks => {
                    const select = $('#code');
                    select.empty(); // 清空现有选项
                    
                    stocks.forEach(stock => {
                        const option = new Option(`${stock.code} - ${stock.name}`, stock.code, false, false);
                        select.append(option);
                    });
                    
                    select.trigger('change'); // 通知select2更新
                    
                    // 如果有默认选择，自动加载图表
                    setTimeout(() => {
                        const currentSelection = select.val();
                        if (currentSelection && currentSelection.length > 0) {
                            console.log('检测到默认选择，自动加载图表:', currentSelection);
                            autoLoadChart();
                        }
                    }, 100);
                })
                .catch(error => {
                    console.error('加载股票列表失败:', error);
                    // 如果加载失败，保留默认选项，并尝试自动加载
                    setTimeout(() => {
                        const select = $('#code');
                        const currentSelection = select.val();
                        if (currentSelection && currentSelection.length > 0) {
                            console.log('使用默认选项，自动加载图表:', currentSelection);
                            autoLoadChart();
                        }
                    }, 100);
                });
        }
        
        // ===== 自动加载函数 =====
        function autoLoadChart() {
            // 清除之前的定时器，实现防抖
            if (loadTimeout) {
                clearTimeout(loadTimeout);
            }
            
            // 延迟执行，避免频繁触发
            loadTimeout = setTimeout(() => {
                const codes = $('#code').val();
                
                // 如果没有选择股票代码，清空图表
                if (!codes || codes.length === 0) {
                    clearChart();
                    return;
                }
                
                loadChart();
            }, 300); // 300ms防抖延迟
        }
        
        // ===== 清空图表函数 =====
        function clearChart() {
            if (chartManager) {
                chartManager.destroy();
                chartManager = new ChartManager();
                window.chartManager = chartManager;
            }
            
            // 清空信息栏
            document.getElementById('info-bar').innerText = '';
            console.log('图表已清空');
        }
        
        // ===== 图表加载函数 =====
        async function loadChart() {
            const codes = $('#code').val();
            if (!codes || codes.length === 0) {
                console.log('没有选择股票代码，跳过加载');
                hideLoadingIndicator();
                return;
            }
            
            const selectedIndicators = [];
            $('.indicator:checked').each(function() {
                selectedIndicators.push($(this).val());
            });
            
            console.log('开始加载图表:', { codes, selectedIndicators });
            
            // 显示加载指示器
            showLoadingIndicator();
            
            // 销毁现有图表
            if (chartManager) {
                chartManager.destroy();
            }
            
            // 重新创建图表管理器
            chartManager = new ChartManager();
            window.chartManager = chartManager;
            
            // 创建主图
            const mainChart = chartManager.createMainChart(document.getElementById('chart'));
            
            // 加载数据
            try {
                await chartManager.loadData(codes, selectedIndicators);
                hideLoadingIndicator();
                console.log('图表加载完成');
            } catch (error) {
                hideLoadingIndicator();
                console.error('图表加载失败:', error);
            }
        }
        
        // ===== 加载指示器函数 =====
        function showLoadingIndicator() {
            const indicator = document.getElementById('loading-indicator');
            if (indicator) {
                indicator.style.display = 'inline';
            }
        }
        
        function hideLoadingIndicator() {
            const indicator = document.getElementById('loading-indicator');
            if (indicator) {
                indicator.style.display = 'none';
            }
        }
        
        // ===== 强制同步图表函数 =====
        function forceSyncCharts() {
            try {
                if (window.chartManager && window.chartManager.forceSyncCharts) {
                    return window.chartManager.forceSyncCharts();
                } else {
                    console.warn('ChartManager或forceSyncCharts方法不可用');
                    return { success: false, message: 'ChartManager不可用' };
                }
            } catch (error) {
                console.error('强制同步失败:', error);
                return { success: false, message: error.message };
            }
        }
        
        // ===== 重置图表函数 =====
        function resetCharts() {
            try {
                console.log('开始重置图表...');
                
                let syncSuccess = false;
                let fitSuccess = false;
                
                // 1. 强制同步所有图表
                const syncResult = forceSyncCharts();
                if (syncResult && syncResult.success) {
                    syncSuccess = true;
                    console.log('强制同步成功:', syncResult.message);
                } else {
                    console.warn('强制同步失败:', syncResult ? syncResult.message : '未知错误');
                }
                
                // 2. 适配数据范围
                if (window.fitChartsToData && typeof window.fitChartsToData === 'function') {
                    window.fitChartsToData();
                    fitSuccess = true;
                    console.log('适配数据范围完成');
                } else if (window.chartManager && window.chartManager.fitAllChartsToData) {
                    const fitResult = window.chartManager.fitAllChartsToData();
                    if (fitResult && fitResult.success) {
                        fitSuccess = true;
                        console.log('适配数据范围成功:', fitResult.message);
                    } else {
                        console.warn('适配数据范围失败:', fitResult ? fitResult.message : '未知错误');
                    }
                }
                
                // 显示结果提示
                const successCount = (syncSuccess ? 1 : 0) + (fitSuccess ? 1 : 0);
                let message = '';
                
                if (successCount === 2) {
                    message = '图表重置完成：已强制同步并适配到数据范围';
                } else if (successCount === 1) {
                    message = '图表重置部分完成：' + (syncSuccess ? '已强制同步' : '已适配数据范围');
                } else {
                    message = '图表重置失败：请检查控制台日志';
                }
                
                console.log('图表重置完成，成功操作数:', successCount);
                alert(message);
                
            } catch (error) {
                console.error('重置图表失败:', error);
                alert('重置图表时发生错误: ' + error.message);
            }
        }
        
        // ===== 兼容性支持 =====
        // 保持与原有代码的兼容性
        window.mainChart = null;
        window.squeezeChart = null;
        window.squeezeChartInstance = null;
        
        // 当主图创建时更新全局变量
        const originalCreateMainChart = ChartManager.prototype.createMainChart;
        ChartManager.prototype.createMainChart = function(container) {
            const result = originalCreateMainChart.call(this, container);
            window.mainChart = result.chart;
            return result;
        };
    </script>
</body>
</html> 