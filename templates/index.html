<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>SuperTrend Chart - V2.1.0</title>
    <script src="/static/lightweight-charts.standalone.production.js"></script>
    <script src="/static/lightweight-charts.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 20px;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 8px;
        }
        
        .form-bar { 
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #e9ecef;
        }
        
        .form-row {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        label { 
            margin-right: 8px;
            font-weight: 500;
            color: #495057;
        }
        
        button { 
            padding: 8px 16px; 
            margin-left: 10px; 
            border: 1px solid #ccc; 
            border-radius: 4px; 
            background-color: #f8f9fa; 
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        button:hover { 
            background-color: #e9ecef; 
            transform: translateY(-1px);
        }
        
        button:active { 
            background-color: #dee2e6; 
            transform: translateY(0);
        }
        
        .reset-btn {
            background-color: #17a2b8;
            color: white;
            border-color: #17a2b8;
            font-weight: 500;
        }
        
        .reset-btn:hover {
            background-color: #138496;
            border-color: #117a8b;
        }
        
        .indicator {
            margin-right: 4px;
        }
        
        .form-bar label {
            display: inline-flex;
            align-items: center;
            margin-right: 12px;
        }
        
        .loading-indicator {
            display: none;
            color: #007bff;
            font-style: italic;
            margin-left: 10px;
        }
        
        .chart-container {
            width: 100%;
            height: 500px;
            border: 1px solid #ddd;
            border-radius: 6px;
            margin: 15px 0;
            background: white;
            position: relative;
        }
        
        .status-bar {
            background: #e9ecef;
            padding: 10px 15px;
            border-radius: 4px;
            margin: 10px 0;
            font-size: 14px;
            color: #495057;
        }
        
        .version-info {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“Š SuperTrend Chart</h1>
            <p>LightWeight Charts V2.1.0 - å¤šè‚¡ç¥¨æŠ€æœ¯åˆ†æå¹³å°</p>
        </div>
        
        <div class="form-bar">
            <div class="form-row">
                <label for="code">è‚¡ç¥¨ä»£ç :</label>
                <select id="code" multiple="multiple" style="width:350px">
                    <option value="HK.09660">HK.09660 - HORIZON ROBOTICS</option>
                    <option value="HK.01810">HK.01810 - å°ç±³é›†å›¢</option>
                    <option value="HK.02432">HK.02432 - é˜¿é‡Œå·´å·´</option>
                </select>
            </div>
            
            <div class="form-row">
                <label>æŠ€æœ¯æŒ‡æ ‡:</label>
                <label><input type="checkbox" class="indicator" value="supertrend" checked>SuperTrend</label>
                <label><input type="checkbox" class="indicator" value="ma5">MA5</label>
                <label><input type="checkbox" class="indicator" value="ma10">MA10</label>
                <label><input type="checkbox" class="indicator" value="squeeze_momentum">Squeeze Momentum</label>
            </div>
            
            <div class="form-row">
                <button onclick="loadChart()" class="reset-btn">åŠ è½½å›¾è¡¨</button>
                <button onclick="resetCharts()" title="é‡ç½®å›¾è¡¨ï¼šé€‚é…åˆ°æ•°æ®èŒƒå›´å¹¶ä¼˜åŒ–æ˜¾ç¤º">é‡ç½®å›¾è¡¨</button>
                <button onclick="clearChart()">æ¸…ç©ºå›¾è¡¨</button>
                <span id="loading-indicator" class="loading-indicator">æ­£åœ¨åŠ è½½å›¾è¡¨...</span>
            </div>
        </div>
        
        <div id="status-bar" class="status-bar">
            å‡†å¤‡å°±ç»ª - è¯·é€‰æ‹©è‚¡ç¥¨ä»£ç å¹¶ç‚¹å‡»"åŠ è½½å›¾è¡¨"
        </div>
        
        <div id="chart-container" class="chart-container">
            <div class="version-info">V2.1.0</div>
        </div>
    </div>

    <script>
        // ===== å…¨å±€å˜é‡ =====
        let mainChart = null;
        let loadTimeout = null; // é˜²æŠ–å®šæ—¶å™¨
        
        // ===== åˆå§‹åŒ– =====
        $(document).ready(function() {
            console.log('ğŸš€ SuperTrend Chart V2.1.0 åˆå§‹åŒ–ä¸­...');
            
            // åˆå§‹åŒ–è‚¡ç¥¨ä»£ç é€‰æ‹©å™¨
            $('#code').select2({
                placeholder: 'è¯·é€‰æ‹©è‚¡ç¥¨ä»£ç ï¼ˆæ”¯æŒå¤šé€‰ï¼‰',
                allowClear: true
            });
            
            // ç›‘å¬è‚¡ç¥¨ä»£ç å˜åŒ–
            $('#code').on('change', function() {
                autoLoadChart();
            });
            
            // ç›‘å¬æŒ‡æ ‡å˜åŒ–
            $('.indicator').on('change', function() {
                autoLoadChart();
            });
            
            // åŠ¨æ€åŠ è½½è‚¡ç¥¨åˆ—è¡¨
            loadStockOptions();
            
            updateStatus('ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ', 'success');
        });
        
        // ===== çŠ¶æ€æ›´æ–°å‡½æ•° =====
        function updateStatus(message, type = 'info') {
            const statusBar = document.getElementById('status-bar');
            const icons = {
                info: 'â„¹ï¸',
                success: 'âœ…',
                error: 'âŒ',
                loading: 'â³'
            };
            
            statusBar.textContent = `${icons[type] || 'â„¹ï¸'} ${message}`;
            statusBar.style.background = {
                info: '#e9ecef',
                success: '#d4edda',
                error: '#f8d7da',
                loading: '#cce5ff'
            }[type] || '#e9ecef';
            
            console.log(`[çŠ¶æ€] ${message}`);
        }
        
        // ===== åŠ è½½è‚¡ç¥¨é€‰é¡¹ =====
        function loadStockOptions() {
            fetch('/api/stocks')
                .then(response => response.json())
                .then(stocks => {
                    const select = $('#code');
                    select.empty(); // æ¸…ç©ºç°æœ‰é€‰é¡¹
                    
                    stocks.forEach(stock => {
                        const option = new Option(`${stock.code} - ${stock.name}`, stock.code, false, false);
                        select.append(option);
                    });
                    
                    select.trigger('change'); // é€šçŸ¥select2æ›´æ–°
                    updateStatus('è‚¡ç¥¨åˆ—è¡¨åŠ è½½å®Œæˆ', 'success');
                })
                .catch(error => {
                    console.error('åŠ è½½è‚¡ç¥¨åˆ—è¡¨å¤±è´¥:', error);
                    updateStatus('è‚¡ç¥¨åˆ—è¡¨åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤é€‰é¡¹', 'error');
                });
        }
        
        // ===== è‡ªåŠ¨åŠ è½½å‡½æ•° =====
        function autoLoadChart() {
            // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨ï¼Œå®ç°é˜²æŠ–
            if (loadTimeout) {
                clearTimeout(loadTimeout);
            }
            
            // å»¶è¿Ÿæ‰§è¡Œï¼Œé¿å…é¢‘ç¹è§¦å‘
            loadTimeout = setTimeout(() => {
                const codes = $('#code').val();
                
                // å¦‚æœæ²¡æœ‰é€‰æ‹©è‚¡ç¥¨ä»£ç ï¼Œæ¸…ç©ºå›¾è¡¨
                if (!codes || codes.length === 0) {
                    clearChart();
                    return;
                }
                
                loadChart();
            }, 500); // 500msé˜²æŠ–å»¶è¿Ÿ
        }
        
        // ===== æ¸…ç©ºå›¾è¡¨å‡½æ•° =====
        function clearChart() {
            if (mainChart) {
                mainChart.destroy();
                mainChart = null;
            }
            
            // æ¸…ç©ºå®¹å™¨
            const container = document.getElementById('chart-container');
            container.innerHTML = '<div class="version-info">V2.1.0</div>';
            
            updateStatus('å›¾è¡¨å·²æ¸…ç©º', 'info');
        }
        
        // ===== å›¾è¡¨åŠ è½½å‡½æ•° =====
        async function loadChart() {
            const codes = $('#code').val();
            if (!codes || codes.length === 0) {
                updateStatus('è¯·é€‰æ‹©è‚¡ç¥¨ä»£ç ', 'error');
                return;
            }
            
            const selectedIndicators = [];
            $('.indicator:checked').each(function() {
                selectedIndicators.push($(this).val());
            });
            
            console.log('å¼€å§‹åŠ è½½å›¾è¡¨:', { codes, selectedIndicators });
            updateStatus('æ­£åœ¨åŠ è½½å›¾è¡¨æ•°æ®...', 'loading');
            
            // æ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨
            showLoadingIndicator();
            
            try {
                // é”€æ¯ç°æœ‰å›¾è¡¨
                if (mainChart) {
                    mainChart.destroy();
                }
                
                // è·å–å›¾è¡¨å®¹å™¨
                const container = document.getElementById('chart-container');
                container.innerHTML = '<div class="version-info">V2.1.0</div>';
                
                // åˆ›å»ºä¸»å›¾
                mainChart = new MainChart(container);
                mainChart.create();
                
                // åˆ›å»ºå­å›¾
                const parentContainer = container.parentElement;
                
                // åˆ›å»ºæˆäº¤é‡å­å›¾
                if (selectedIndicators.includes('squeeze_momentum')) {
                    // å¦‚æœåŒ…å«SqueezeæŒ‡æ ‡ï¼Œåˆ›å»ºæˆäº¤é‡å’ŒSqueezeå­å›¾
                    mainChart.createVolumeSubChart(parentContainer);
                    mainChart.createSqueezeSubChart(parentContainer);
                } else {
                    // å¦åˆ™åªåˆ›å»ºæˆäº¤é‡å­å›¾
                    mainChart.createVolumeSubChart(parentContainer);
                }
                
                // åŠ è½½æ•°æ®
                await mainChart.loadData(codes, selectedIndicators);
                
                updateStatus(`å›¾è¡¨åŠ è½½å®Œæˆ - ${codes.length}åªè‚¡ç¥¨ï¼Œ${selectedIndicators.length}ä¸ªæŒ‡æ ‡`, 'success');
                hideLoadingIndicator();
                
                console.log('âœ… å›¾è¡¨åŠ è½½å®Œæˆ');
                
            } catch (error) {
                hideLoadingIndicator();
                updateStatus('å›¾è¡¨åŠ è½½å¤±è´¥: ' + error.message, 'error');
                console.error('âŒ å›¾è¡¨åŠ è½½å¤±è´¥:', error);
            }
        }
        
        // ===== åŠ è½½æŒ‡ç¤ºå™¨å‡½æ•° =====
        function showLoadingIndicator() {
            const indicator = document.getElementById('loading-indicator');
            if (indicator) {
                indicator.style.display = 'inline';
            }
        }
        
        function hideLoadingIndicator() {
            const indicator = document.getElementById('loading-indicator');
            if (indicator) {
                indicator.style.display = 'none';
            }
        }
        
        // ===== é‡ç½®å›¾è¡¨å‡½æ•° =====
        function resetCharts() {
            if (!mainChart) {
                updateStatus('æ²¡æœ‰å›¾è¡¨éœ€è¦é‡ç½®', 'error');
                return;
            }
            
            try {
                console.log('å¼€å§‹é‡ç½®å›¾è¡¨...');
                updateStatus('æ­£åœ¨é‡ç½®å›¾è¡¨...', 'loading');
                
                // é€‚é…å†…å®¹åˆ°æ•°æ®èŒƒå›´
                mainChart.fitContentToData();
                
                // ä¼˜åŒ–ä»·æ ¼èŒƒå›´
                setTimeout(() => {
                    if (mainChart.optimizePriceRange) {
                        mainChart.optimizePriceRange();
                    }
                }, 100);
                
                updateStatus('å›¾è¡¨é‡ç½®å®Œæˆ', 'success');
                console.log('âœ… å›¾è¡¨é‡ç½®å®Œæˆ');
                
            } catch (error) {
                updateStatus('å›¾è¡¨é‡ç½®å¤±è´¥: ' + error.message, 'error');
                console.error('âŒ é‡ç½®å›¾è¡¨å¤±è´¥:', error);
            }
        }
        
        // ===== å…¨å±€å˜é‡å¯¼å‡ºï¼ˆå…¼å®¹æ€§ï¼‰ =====
        window.mainChart = null;
        
        // ç›‘å¬ä¸»å›¾åˆ›å»ºï¼Œæ›´æ–°å…¨å±€å˜é‡
        document.addEventListener('DOMContentLoaded', function() {
            // å®šæœŸæ£€æŸ¥å¹¶æ›´æ–°å…¨å±€å˜é‡
            setInterval(() => {
                if (mainChart && mainChart !== window.mainChart) {
                    window.mainChart = mainChart;
                }
            }, 1000);
        });
        
        console.log('ğŸ“Š SuperTrend Chart V2.1.0 è„šæœ¬åŠ è½½å®Œæˆ');
    </script>
</body>
</html> 
</html> 