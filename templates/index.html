<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>SuperTrend Chart</title>
    <script src="/static/lightweight-charts.standalone.production.js"></script>
    <script src="/static/lightweight-charts.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <style>
        #chart { width: 1000px; height: 400px; }
        #volume-chart { width: 1000px; height: 200px; margin-top: 8px; }
        body { font-family: Arial, sans-serif; }
        .form-bar { margin-bottom: 16px; }
        label { margin-right: 8px; }
        button { 
            padding: 6px 12px; 
            margin-left: 10px; 
            border: 1px solid #ccc; 
            border-radius: 4px; 
            background-color: #f8f9fa; 
            cursor: pointer; 
        }
        button:hover { 
            background-color: #e9ecef; 
        }
        button:active { 
            background-color: #dee2e6; 
        }
        .reset-btn {
            background-color: #17a2b8;
            color: white;
            border-color: #17a2b8;
            font-weight: 500;
        }
        .reset-btn:hover {
            background-color: #138496;
            border-color: #117a8b;
        }
        .indicator {
            margin-right: 4px;
        }
        .form-bar label {
            display: inline-flex;
            align-items: center;
            margin-right: 12px;
        }
        .loading-indicator {
            display: none;
            color: #007bff;
            font-style: italic;
            margin-left: 10px;
        }
    </style>
</head>
<body>
    <div class="form-bar">
        <label for="code">è‚¡ç¥¨ä»£ç :</label>
        <select id="code" multiple="multiple" style="width:300px">
            <option value="HK.09660">HK.09660 - HORIZON ROBOTICS</option>
            <option value="09660.HK">09660.HK - HORIZON ROBOTICS</option>
        </select>
        <label>æŒ‡æ ‡:</label>
        <label><input type="checkbox" class="indicator" value="supertrend" checked>SuperTrend</label>
        <label><input type="checkbox" class="indicator" value="ma5">MA5</label>
        <label><input type="checkbox" class="indicator" value="ma10">MA10</label>
        <label><input type="checkbox" class="indicator" value="squeeze_momentum">Squeeze Momentum</label>
        <button onclick="resetCharts()" class="reset-btn" title="é‡ç½®å›¾è¡¨ï¼šå¼ºåˆ¶åŒæ­¥æ‰€æœ‰å›¾è¡¨å¹¶é€‚é…åˆ°å®é™…æ•°æ®èŒƒå›´">é‡ç½®å›¾è¡¨</button>
        <span id="loading-indicator" class="loading-indicator">æ­£åœ¨åŠ è½½å›¾è¡¨...</span>
    </div>
    <div id="info-bar" style="font-size:14px; margin-bottom:8px; line-height:1.4; max-height:120px; overflow-y:auto; padding:8px; border:1px solid #e0e0e0; border-radius:4px; background-color:#f9f9f9;"></div>
    <div id="chart"></div>
    <div id="volume-chart"></div>
    <script>
        // ===== å…¨å±€å˜é‡ =====
        let chartManager = null;
        window.chartManager = null; // ç¡®ä¿å…¨å±€å¯è®¿é—®
        let loadTimeout = null; // é˜²æŠ–å®šæ—¶å™¨
        
        // ===== åˆå§‹åŒ– =====
        $(document).ready(function() {
            // åˆå§‹åŒ–å›¾è¡¨ç®¡ç†å™¨
            chartManager = new ChartManager();
            window.chartManager = chartManager;
            
            // åˆå§‹åŒ–è‚¡ç¥¨ä»£ç é€‰æ‹©å™¨
            $('#code').select2({
                placeholder: 'è¯·é€‰æ‹©è‚¡ç¥¨ä»£ç ',
                allowClear: true
            });
            
            // ç›‘å¬è‚¡ç¥¨ä»£ç å˜åŒ–
            $('#code').on('change', function() {
                autoLoadChart();
            });
            
            // ç›‘å¬æŒ‡æ ‡å˜åŒ–
            $('.indicator').on('change', function() {
                autoLoadChart();
            });
            
            // åŠ¨æ€åŠ è½½è‚¡ç¥¨åˆ—è¡¨
            loadStockOptions();
        });
        
        // ===== åŠ è½½è‚¡ç¥¨é€‰é¡¹ =====
        function loadStockOptions() {
            fetch('/api/stocks')
                .then(response => response.json())
                .then(stocks => {
                    const select = $('#code');
                    select.empty(); // æ¸…ç©ºç°æœ‰é€‰é¡¹
                    
                    stocks.forEach(stock => {
                        const option = new Option(`${stock.code} - ${stock.name}`, stock.code, false, false);
                        select.append(option);
                    });
                    
                    select.trigger('change'); // é€šçŸ¥select2æ›´æ–°
                    
                    // å¦‚æœæœ‰é»˜è®¤é€‰æ‹©ï¼Œè‡ªåŠ¨åŠ è½½å›¾è¡¨
                    setTimeout(() => {
                        const currentSelection = select.val();
                        if (currentSelection && currentSelection.length > 0) {
                            console.log('æ£€æµ‹åˆ°é»˜è®¤é€‰æ‹©ï¼Œè‡ªåŠ¨åŠ è½½å›¾è¡¨:', currentSelection);
                            autoLoadChart();
                        }
                    }, 100);
                })
                .catch(error => {
                    console.error('åŠ è½½è‚¡ç¥¨åˆ—è¡¨å¤±è´¥:', error);
                    // å¦‚æœåŠ è½½å¤±è´¥ï¼Œä¿ç•™é»˜è®¤é€‰é¡¹ï¼Œå¹¶å°è¯•è‡ªåŠ¨åŠ è½½
                    setTimeout(() => {
                        const select = $('#code');
                        const currentSelection = select.val();
                        if (currentSelection && currentSelection.length > 0) {
                            console.log('ä½¿ç”¨é»˜è®¤é€‰é¡¹ï¼Œè‡ªåŠ¨åŠ è½½å›¾è¡¨:', currentSelection);
                            autoLoadChart();
                        }
                    }, 100);
                });
        }
        
        // ===== è‡ªåŠ¨åŠ è½½å‡½æ•° =====
        function autoLoadChart() {
            // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨ï¼Œå®ç°é˜²æŠ–
            if (loadTimeout) {
                clearTimeout(loadTimeout);
            }
            
            // å»¶è¿Ÿæ‰§è¡Œï¼Œé¿å…é¢‘ç¹è§¦å‘
            loadTimeout = setTimeout(() => {
                const codes = $('#code').val();
                
                // å¦‚æœæ²¡æœ‰é€‰æ‹©è‚¡ç¥¨ä»£ç ï¼Œæ¸…ç©ºå›¾è¡¨
                if (!codes || codes.length === 0) {
                    clearChart();
                    return;
                }
                
                loadChart();
            }, 300); // 300msé˜²æŠ–å»¶è¿Ÿ
        }
        
        // ===== æ¸…ç©ºå›¾è¡¨å‡½æ•° =====
        function clearChart() {
            if (chartManager) {
                chartManager.destroy();
                chartManager = new ChartManager();
                window.chartManager = chartManager;
            }
            
            // æ¸…ç©ºä¿¡æ¯æ 
            document.getElementById('info-bar').innerText = '';
            console.log('å›¾è¡¨å·²æ¸…ç©º');
        }
        
        // ===== å›¾è¡¨åŠ è½½å‡½æ•° =====
        async function loadChart() {
            const codes = $('#code').val();
            if (!codes || codes.length === 0) {
                console.log('æ²¡æœ‰é€‰æ‹©è‚¡ç¥¨ä»£ç ï¼Œè·³è¿‡åŠ è½½');
                hideLoadingIndicator();
                return;
            }
            
            const selectedIndicators = [];
            $('.indicator:checked').each(function() {
                selectedIndicators.push($(this).val());
            });
            
            console.log('å¼€å§‹åŠ è½½å›¾è¡¨:', { codes, selectedIndicators });
            
            // æ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨
            showLoadingIndicator();
            
            // é”€æ¯ç°æœ‰å›¾è¡¨
            if (chartManager) {
                chartManager.destroy();
            }
            
            // é‡æ–°åˆ›å»ºå›¾è¡¨ç®¡ç†å™¨
            chartManager = new ChartManager();
            window.chartManager = chartManager;
            
            try {
                // å§‹ç»ˆä½¿ç”¨å¤šé¢æ¿å¸ƒå±€ï¼Œå®ç°Kçº¿å’Œæˆäº¤é‡å®Œå…¨åˆ†ç¦»
                console.log('ğŸ¯ ä½¿ç”¨å¤šé¢æ¿å¸ƒå±€ï¼ˆKçº¿ä¸æˆäº¤é‡åˆ†ç¦»ï¼‰');
                const multiPanelManager = chartManager.createMultiPanelChart(document.getElementById('chart'));
                await multiPanelManager.loadData(codes, selectedIndicators);
                
                // å…¼å®¹æ€§æ”¯æŒ
                window.mainChart = multiPanelManager.mainChart.chart;
                
                hideLoadingIndicator();
                console.log('å›¾è¡¨åŠ è½½å®Œæˆ');
            } catch (error) {
                hideLoadingIndicator();
                console.error('å›¾è¡¨åŠ è½½å¤±è´¥:', error);
                alert('å›¾è¡¨åŠ è½½å¤±è´¥: ' + error.message);
            }
        }
        
        // ===== åŠ è½½æŒ‡ç¤ºå™¨å‡½æ•° =====
        function showLoadingIndicator() {
            const indicator = document.getElementById('loading-indicator');
            if (indicator) {
                indicator.style.display = 'inline';
            }
        }
        
        function hideLoadingIndicator() {
            const indicator = document.getElementById('loading-indicator');
            if (indicator) {
                indicator.style.display = 'none';
            }
        }
        
        // ===== å¼ºåˆ¶åŒæ­¥å›¾è¡¨å‡½æ•° =====
        function forceSyncCharts() {
            try {
                if (window.chartManager && window.chartManager.forceSyncCharts) {
                    return window.chartManager.forceSyncCharts();
                } else {
                    console.warn('ChartManageræˆ–forceSyncChartsæ–¹æ³•ä¸å¯ç”¨');
                    return { success: false, message: 'ChartManagerä¸å¯ç”¨' };
                }
            } catch (error) {
                console.error('å¼ºåˆ¶åŒæ­¥å¤±è´¥:', error);
                return { success: false, message: error.message };
            }
        }
        
        // ===== é‡ç½®å›¾è¡¨å‡½æ•° =====
        function resetCharts() {
            try {
                console.log('å¼€å§‹é‡ç½®å›¾è¡¨...');
                
                let syncSuccess = false;
                let fitSuccess = false;
                
                // 1. å¼ºåˆ¶åŒæ­¥æ‰€æœ‰å›¾è¡¨
                const syncResult = forceSyncCharts();
                if (syncResult && syncResult.success) {
                    syncSuccess = true;
                    console.log('å¼ºåˆ¶åŒæ­¥æˆåŠŸ:', syncResult.message);
                } else {
                    console.warn('å¼ºåˆ¶åŒæ­¥å¤±è´¥:', syncResult ? syncResult.message : 'æœªçŸ¥é”™è¯¯');
                }
                
                // 2. é€‚é…æ•°æ®èŒƒå›´
                if (window.fitChartsToData && typeof window.fitChartsToData === 'function') {
                    window.fitChartsToData();
                    fitSuccess = true;
                    console.log('é€‚é…æ•°æ®èŒƒå›´å®Œæˆ');
                } else if (window.chartManager && window.chartManager.fitAllChartsToData) {
                    const fitResult = window.chartManager.fitAllChartsToData();
                    if (fitResult && fitResult.success) {
                        fitSuccess = true;
                        console.log('é€‚é…æ•°æ®èŒƒå›´æˆåŠŸ:', fitResult.message);
                    } else {
                        console.warn('é€‚é…æ•°æ®èŒƒå›´å¤±è´¥:', fitResult ? fitResult.message : 'æœªçŸ¥é”™è¯¯');
                    }
                }
                
                // æ˜¾ç¤ºç»“æœæç¤º
                const successCount = (syncSuccess ? 1 : 0) + (fitSuccess ? 1 : 0);
                let message = '';
                
                if (successCount === 2) {
                    message = 'å›¾è¡¨é‡ç½®å®Œæˆï¼šå·²å¼ºåˆ¶åŒæ­¥å¹¶é€‚é…åˆ°æ•°æ®èŒƒå›´';
                } else if (successCount === 1) {
                    message = 'å›¾è¡¨é‡ç½®éƒ¨åˆ†å®Œæˆï¼š' + (syncSuccess ? 'å·²å¼ºåˆ¶åŒæ­¥' : 'å·²é€‚é…æ•°æ®èŒƒå›´');
                } else {
                    message = 'å›¾è¡¨é‡ç½®å¤±è´¥ï¼šè¯·æ£€æŸ¥æ§åˆ¶å°æ—¥å¿—';
                }
                
                console.log('å›¾è¡¨é‡ç½®å®Œæˆï¼ŒæˆåŠŸæ“ä½œæ•°:', successCount);
                alert(message);
                
            } catch (error) {
                console.error('é‡ç½®å›¾è¡¨å¤±è´¥:', error);
                alert('é‡ç½®å›¾è¡¨æ—¶å‘ç”Ÿé”™è¯¯: ' + error.message);
            }
        }
        
        // ===== å…¼å®¹æ€§æ”¯æŒ =====
        // ä¿æŒä¸åŸæœ‰ä»£ç çš„å…¼å®¹æ€§
        window.mainChart = null;
        window.squeezeChart = null;
        window.squeezeChartInstance = null;
        
        // å½“ä¸»å›¾åˆ›å»ºæ—¶æ›´æ–°å…¨å±€å˜é‡
        const originalCreateMainChart = ChartManager.prototype.createMainChart;
        ChartManager.prototype.createMainChart = function(container) {
            const result = originalCreateMainChart.call(this, container);
            window.mainChart = result.chart;
            return result;
        };
    </script>
</body>
</html> 