<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>SuperTrend Chart</title>
    <script src="/static/lightweight-charts.standalone.production.js"></script>
    <script src="/static/lightweight-charts.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <style>
        #chart { width: 1000px; height: 400px; }
        #volume-chart { width: 1000px; height: 200px; margin-top: 8px; }
        body { font-family: Arial, sans-serif; }
        .form-bar { margin-bottom: 16px; }
        label { margin-right: 8px; }
    </style>
</head>
<body>
    <div class="form-bar">
        <label for="code">股票代码:</label>
        <select id="code" multiple="multiple" style="width:300px">
            <option value="HK.09660">HK.09660 - HORIZON ROBOTICS</option>
            <option value="09660.HK">09660.HK - HORIZON ROBOTICS</option>
        </select>
        <label>指标:</label>
        <label><input type="checkbox" class="indicator" value="supertrend" checked>SuperTrend</label>
        <label><input type="checkbox" class="indicator" value="ma5">MA5</label>
        <label><input type="checkbox" class="indicator" value="ma10">MA10</label>
        <label><input type="checkbox" class="indicator" value="squeeze_momentum">Squeeze Momentum</label>
        <button onclick="loadChart()">查询</button>
        <button onclick="forceSyncCharts()" style="margin-left: 10px;">强制同步</button>
    </div>
    <div id="info-bar" style="font-size:16px; margin-bottom:8px;"></div>
    <div id="chart"></div>
    <div id="volume-chart"></div>
    <script>
        // ===== 全局变量 =====
        let chartManager = null;
        
        // ===== 初始化 =====
        $(document).ready(function() {
            // 初始化图表管理器
            chartManager = new ChartManager();
            
            // 初始化股票代码选择器（简化版本）
            $('#code').select2({
                placeholder: '请选择股票代码',
                allowClear: true
            });
            
            // 动态加载股票列表
            loadStockOptions();
        });
        
        // ===== 加载股票选项 =====
        function loadStockOptions() {
            fetch('/api/stocks')
                .then(response => response.json())
                .then(stocks => {
                    const select = $('#code');
                    select.empty(); // 清空现有选项
                    
                    stocks.forEach(stock => {
                        const option = new Option(`${stock.code} - ${stock.name}`, stock.code, false, false);
                        select.append(option);
                    });
                    
                    select.trigger('change'); // 通知select2更新
                })
                .catch(error => {
                    console.error('加载股票列表失败:', error);
                    // 如果加载失败，保留默认选项
                });
        }
        
        // ===== 图表加载函数 =====
        function loadChart() {
            const codes = $('#code').val();
            if (!codes || codes.length === 0) {
                alert('请选择至少一个股票代码');
                return;
            }
            
            const selectedIndicators = [];
            $('.indicator:checked').each(function() {
                selectedIndicators.push($(this).val());
            });
            
            // 销毁现有图表
            if (chartManager) {
                chartManager.destroy();
            }
            
            // 重新创建图表管理器
            chartManager = new ChartManager();
            
            // 创建主图
            const mainChart = chartManager.createMainChart(document.getElementById('chart'));
            
            // 加载数据
            chartManager.loadData(codes, selectedIndicators);
        }
        
        // ===== 兼容性支持 =====
        // 保持与原有代码的兼容性
        window.mainChart = null;
        window.squeezeChart = null;
        window.squeezeChartInstance = null;
        
        // 当主图创建时更新全局变量
        const originalCreateMainChart = ChartManager.prototype.createMainChart;
        ChartManager.prototype.createMainChart = function(container) {
            const result = originalCreateMainChart.call(this, container);
            window.mainChart = result.chart;
            return result;
        };
    </script>
</body>
</html> 